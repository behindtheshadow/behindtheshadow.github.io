---
layout: post
title:  "TileStrata PostGIS geojson tiles 插件"
date:   2017-07-19 20:48:00 +0800
categories:
- GIS
- TileStrata
comments: true
---
一个 TileStrata 插件，用以从 PostGIS 中生成 geojson 切片

# 配置
- `geometryField` (string, required): 保存空间数据的列名，默认`"gemo"`
- `sql` (function, required): 函数返回将被执行的 PostGIS 语句，包含以下内容：
  - `{bbox}` (box2d): box 周围的缓存
  - `{geojson}` (text): geojson 表示的被修剪和简化的空间信息
- `pgConfig` (object, required): PostGIS 连接配置
  - `{host}` (string):
  - `{password}` (string): 
  - `{user}` (string): 
  - `{port}` (string): 
  - `{database}` (string): 
- `simplifyFactor` (number, optional): 一个影响空间数据简化程度的常数，默认`0.75`
- `buffer` (number, optional) 以像素为单位，围绕每个切片的缓存大小，默认为`16`

# 示例
```javascript
// ...

var layer = server.layer('basemap');

layer.route('tile.png')
  .use(disk.cache({
    dir: './tiles/srtm/',
    maxage: 0
  }))
  .use(mapnik({
    pathname: './map.xml',
    tileSize: 256,
    scale: 1
  }));

layer.route('tile.json')
  .use(headers({
    'Access-Control-Allow-Origin': '*'
  }))
  .use(tilestrataPostGISGeoJSON({
    geometryField: 'geom',
    sql: function(server, req) {
      return 'SELECT gid, name, {geojson} FROM world_borders WHERE ST_Intersects(geom, {bbox})';
    },
    pgConfig: {
      username: 'postgres',
      password: '123456',
      host: '127.0.0.1',
      port: '5432',
      database: 'test'
    }
  }));

// ...
```

以 url： `http://localhost:8082/basemap/5/17/14/tile.json` 结果为例,它的切片图像为：
![ScreenShot]({{ site.url }}/public/img/2017/07/19/19-36-35.png)


```json
{
  "type":"FeatureCollection",
  "features":[
    {
      "type":"Feature",
      "geometry":{
        "type":"Polygon",
        "coordinates":[
          [
            [
              14.577221,
              12.7386090000001
            ],
            [
              14.7116660000001,
              12.7138879999999
            ],
            [
              14.8258530000001,
              12.630348
            ],
            [
              14.9023480000001,
              12.375975
            ],
            [
              14.891754,
              12.1533970000001
            ],
            [
              14.9536090000001,
              12.0961090000001
            ],
            [
              15.042597,
              12.078888
            ],
            [
              15.081944,
              11.7547210000001
            ],
            [
              15.061666,
              11.687222
            ],
            [
              15.110832,
              11.49861
            ],
            [
              15.0513879999999,
              11.396666
            ],
            [
              15.017221,
              11.1991649999999
            ],
            [
              15.0780540000001,
              10.895555
            ],
            [
              15.061666,
              10.7899990000001
            ],
            [
              15.1890077151772,
              10.5056116449789
            ],
            [
              13.5319814529618,
              10.5056116449789
            ],
            [
              13.5608330000001,
              10.6436100000001
            ],
            [
              13.768055,
              10.9316650000001
            ],
            [
              13.8072200000001,
              11.055832
            ],
            [
              14.003611,
              11.283333
            ],
            [
              14.18861,
              11.244165
            ],
            [
              14.610554,
              11.4991660000001
            ],
            [
              14.6425,
              11.565554
            ],
            [
              14.5886100000001,
              11.754999
            ],
            [
              14.6308330000001,
              11.891388
            ],
            [
              14.6452770000001,
              12.1883320000001
            ],
            [
              14.4908330000001,
              12.335833
            ],
            [
              14.2358320000001,
              12.3538880000001
            ],
            [
              14.1744440000001,
              12.396666
            ],
            [
              14.1991650000001,
              12.5013890000001
            ],
            [
              14.0747200000001,
              13.0816650000001
            ],
            [
              14.4430540000001,
              13.084721
            ],
            [
              14.5255550000001,
              12.9749980000001
            ],
            [
              14.544722,
              12.776943
            ],
            [
              14.577221,
              12.7386090000001
            ]
          ]
        ]
      },
      "properties":{
        "gid":35,
        "name":"Cameroon"
      }
    },
    ...
    {
      "type":"Feature",
      "geometry":{
        "type":"Polygon",
        "coordinates":[
          [
            [
              23.203125,
              10.5411052989658
            ],
            [
              23.009441,
              10.69861
            ],
            [
              22.8665050000001,
              10.922447
            ],
            [
              22.9747199999999,
              11.209166
            ],
            [
              22.970833,
              11.283054
            ],
            [
              22.9308320000001,
              11.4158330000001
            ],
            [
              22.790276,
              11.429443
            ],
            [
              22.6419409999999,
              11.516109
            ],
            [
              22.561665,
              11.621666
            ],
            [
              22.611385,
              11.9927769999999
            ],
            [
              22.5033300000001,
              12.165833
            ],
            [
              22.4063870000001,
              12.483055
            ],
            [
              22.4669420000001,
              12.621666
            ],
            [
              22.2233310000001,
              12.747221
            ],
            [
              22.1405530000001,
              12.6552770000001
            ],
            [
              21.9527739999999,
              12.6438880000001
            ],
            [
              21.827774,
              12.7974990000001
            ],
            [
              21.9433330000001,
              13.05361
            ],
            [
              22.0205540000001,
              13.1377770000001
            ],
            [
              22.159721,
              13.1902770000001
            ],
            [
              22.294167,
              13.35861
            ],
            [
              22.084442,
              13.779165
            ],
            [
              22.2302740000001,
              13.9627760000001
            ],
            [
              22.5549960000001,
              14.1255550000001
            ],
            [
              22.5552749999999,
              14.231943
            ],
            [
              22.5116649999999,
              14.2402760000001
            ],
            [
              22.449444,
              14.3300000000001
            ],
            [
              22.4455530000001,
              14.4797209999999
            ],
            [
              22.384163,
              14.5541650000001
            ],
            [
              22.4699970000001,
              14.6294439999999
            ],
            [
              22.7024989999999,
              14.691387
            ],
            [
              22.6705549999999,
              14.8594440000001
            ],
            [
              22.849163,
              15.078333
            ],
            [
              22.9358330000001,
              15.11611
            ],
            [
              22.9983330000001,
              15.3563879999999
            ],
            [
              22.9230540000001,
              15.487221
            ],
            [
              22.9372220000001,
              15.5619430000001
            ],
            [
              23.1181560000001,
              15.710293
            ],
            [
              23.203125,
              15.7001060429801
            ],
            [
              23.203125,
              10.5411052989658
            ]
          ]
        ]
      },
      "properties":{
        "gid":190,
        "name":"Sudan"
      }
    }
  ]
}

```

生成的 Json 数据即包含切片的相关空间信息
![ScreenShot]({{ site.url }}/public/img/2017/07/19/19-28-36.png)









